<!DOCTYPE html>  <html lang="hi">  
<head>  
<meta charset="UTF-8">  
<link rel="manifest" href="manifest.json">  
<title>Mandi App Final</title>  
<meta name="viewport" content="width=device-width, initial-scale=1">  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>  
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>  
<style>  
body{font-family:Arial;padding:12px;background:#eef0f4;}  
button,input,select{  
 width:100%;padding:10px;margin:6px 0;border-radius:6px;  
 border:1px solid #aaa;font-size:15px;  
}  
button{background:#0d6efd;color:#fff;border:none;}  
.tableBox{background:#fff;border-radius:6px;overflow-y:auto;max-height:400px;}  
table{width:100%;border-collapse:collapse;}  
th,td{border:1px solid #ccc;padding:8px;font-size:14px;}  
th{background:#0d6efd;color:#fff;}  
.actionBtn{padding:4px 8px;background:#444;color:#fff;border:none;border-radius:4px;}  
.searchBar{background:#d9edff;padding:10px;border-radius:6px;margin-bottom:10px;}  
#entryScreen,#seasonScreen{  
 position:fixed;top:0;left:0;right:0;bottom:0;  
 background:#fff;padding:14px;display:none;z-index:999;overflow-y:auto;  
}  

/* Checkbox Style */
.print-check { width: 20px; height: 20px; cursor: pointer; }

/* --- ZOOM PREVIEW MODAL FIX --- */
#printPreviewModal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.9); z-index: 10000; display: none;
  flex-direction: column;
}
.previewHeader { background: #fff; padding: 10px; display: flex; gap: 10px; align-items: center; justify-content: space-between;}
.previewBody { 
  flex: 1; 
  overflow: auto; 
  padding: 20px; 
  background: #555; 
  display: block; 
}
#previewContent { 
  background: #fff; 
  padding: 20px; 
  transform-origin: top left; 
  width: fit-content; 
  margin: 0 auto;
}

@media print {
  @page{
    size: A4 landscape;
    margin: 8mm;
  }
  body * { visibility: hidden; }
  #previewContent, #previewContent * { visibility: visible; }
  #previewContent { 
    position: absolute; left: 0; top: 0; 
    width: 100% !important; 
    transform: scale(var(--p-zoom)) !important; 
    transform-origin: top left; 
    padding: 0; margin: 0;
  }
  .no-print { display: none !important; }
}

.tableBox{ overflow-x:auto; }
thead th:nth-child(3){ position: sticky; left: 0; background:#0d6efd; z-index: 2; }
tbody td:nth-child(3){ position: sticky; left: 0; background:#fff; z-index: 1; }
</style>  </head>  
<body>  

<div class="no-print">
<select id="season" onchange="onSeasonChange()"></select>
<button onclick="newSeason()">‚ûï New Season</button>

<div style="display:flex;gap:6px;">  
<button onclick="openSeasonScreen()">‚öô Season Setup</button>  
<button onclick="openEntryScreen()">‚ûï Add Entry</button>  
</div>  <div class="searchBar">  
<input id="searchName" placeholder="Search Customer" oninput="filterData()">  
<input type="date" id="fromDate" oninput="filterData()">  
<input type="date" id="toDate" oninput="filterData()">  
</div>  <div style="display:flex;gap:6px;">  
<button onclick="sortNewest()">Newest</button>  
<button onclick="sortOldest()">Oldest</button>  
<button onclick="sortNameAZ()">A ‚Üí Z</button>  
<button onclick="sortNameZA()">Z ‚Üí A</button>  
</div>  <div style="background:white;padding:10px;border-radius:6px;margin:10px 0;">  
<b>Total Bore:</b> <span id="totalBore">0</span> |  
<b>Total Quintal:</b> <span id="totalQtl">0</span>  
<button onclick="openCustomPreview()" style="background:#198754;">üñ® Print Selected / All</button>  
</div>  
</div>

<div class="tableBox no-print">  
<table>  
<thead>  
<tr>  
  <th style="width:30px;"><input type="checkbox" onclick="toggleAll(this)"></th>
  <th>Date</th>  
  <th>Customer</th>  
<th>Father</th>
  <th>Village</th>  
  <th>Bore</th>  
  <th>Extra Kg</th>
<th>Note</th>
<th>Qtl</th>
<th>Amount ‚Çπ</th>
<th>Actions</th>
</tr>  
</thead>  
<tbody id="output"></tbody>  
</table>  
</div>  

<div id="printPreviewModal">
    <div class="previewHeader no-print">
        <button onclick="closePreview()" style="background:#dc3545; width:auto;">Cancel</button>
        <div style="display:flex; align-items:center; gap:8px;">
            <span>Zoom:</span>
            <input type="range" id="zoomRange" min="0.5" max="2.0" step="0.05" value="1.0" style="width:120px;" oninput="applyZoom()">
            <b id="zoomVal">100%</b>
        </div>
        <button onclick="window.print()" style="background:#198754; width:auto;">Print Now</button>
    </div>
    <div class="previewBody">
        <div id="previewContent"></div>
    </div>
</div>

<div id="entryScreen">  
<h3>Add / Edit Entry</h3>  
<div id="entrySeasonLabel" style="font-weight:bold;color:#0d6efd"></div>  
<input id="customer" list="customerList" placeholder="Customer">
<datalist id="customerList"></datalist>
<input id="father" list="fatherList" placeholder="Father (optional)">
<datalist id="fatherList"></datalist>
<input id="village" list="villageList" placeholder="Village">
<datalist id="villageList"></datalist>
<input type="date" id="entryDate">  
<input id="defaultBW" readonly placeholder="Bore Weight">  
<input id="bore" type="number" placeholder="Bore" oninput="autoCalc()" onblur="autoCalc()">  
<input id="extra" type="number" placeholder="Extra Kg" oninput="autoCalc()" onblur="autoCalc()">
<input id="quintal" readonly placeholder="Quintal">
<input id="rate" type="number" placeholder="Rate ‚Çπ / Quintal" oninput="calcAmount()">
<label><input type="checkbox" id="cutBag" onchange="calcAmount()"> Labour per bag</label>
<input id="cutBagVal" type="number" value="60" oninput="calcAmount()">
<label><input type="checkbox" id="cutQtl" onchange="calcAmount()"> Labour per Quintal</label>
<input id="cutQtlVal" type="number" value="60" oninput="calcAmount()">
<input id="cutTotal" readonly placeholder="Total Labour ‚Çπ">
<input id="amount" readonly placeholder="Final Amount ‚Çπ">
<input id="note" placeholder="Note (optional)">
<button onclick="saveEntry()">‚úî Save</button>
<button onclick="closeEntryScreen()">‚¨Ö Back</button>
</div>  

<div id="seasonScreen">  
<h3>Season Setup</h3>  
<input id="seasonName" placeholder="Season Name">  
<input id="seasonWeight" placeholder="Default Bore Weight">  
<button onclick="saveSeason()">‚úî Save</button>  
<button onclick="deleteSeason()">üóë Delete</button>  
<button onclick="closeSeasonScreen()">‚¨Ö Back</button>  
</div>  

<script>  
/* FIREBASE */  
firebase.initializeApp({  
 apiKey:"AIzaSyAiwfHxzsreDK2RkYLXNjhb8DhMmpYZ-tY",  
 authDomain:"fasal-9a05b.firebaseapp.com",  
 databaseURL:"https://fasal-9a05b-default-rtdb.firebaseio.com",  
 projectId:"fasal-9a05b"  
});  
const db=firebase.database();  
let editID=null, defaultBW=0, sortMode = "newest";

/* PRINT PREVIEW LOGIC */
function openCustomPreview() {
    const s = document.getElementById("season").value;
    const selectedChecks = document.querySelectorAll('.print-row-check:checked');
    
    let content = `<h2 style="text-align:center;">${s}</h2>`;
    
    let tableHTML = `<table style="width:100%; border-collapse:collapse; border:1px solid #000;">
        <thead>
            <tr style="background:#eee;">
                <th>Date</th><th>Customer</th><th>Father</th><th>Village</th>
                <th>Bore</th><th>Extra Kg</th><th>Note</th><th>Qtl</th><th>Amount ‚Çπ</th>
            </tr>
        </thead>
        <tbody>`;

    let rowsToPrint = [];
    if(selectedChecks.length > 0) {
        selectedChecks.forEach(chk => { rowsToPrint.push(chk.closest('tr')); });
    } else {
        rowsToPrint = Array.from(document.querySelectorAll('#output tr'));
    }

    let printBore = 0;

    rowsToPrint.forEach(tr => {
        let cells = tr.querySelectorAll('td');
        tableHTML += `<tr>
            <td>${cells[1].innerText}</td>
            <td style="font-weight:bold; color:#0d6efd;">${cells[2].innerText}</td>
            <td>${cells[3].innerText}</td>
            <td>${cells[4].innerText}</td>
            <td>${cells[5].innerText}</td>
            <td>${cells[6].innerText}</td>
            <td>${cells[7].innerText}</td>
            <td>${cells[8].innerText}</td>
            <td>${cells[9].innerHTML.replace(/Cut/g, "Labour")}</td>
        </tr>`;
        
        printBore += Number(cells[5].innerText || 0);
    });

    tableHTML += `</tbody></table>`;
    
    content += `<p style="text-align:center;"><b>Entries:</b> ${rowsToPrint.length} | <b>Total Bore:</b> ${printBore}</p>`;
    content += tableHTML;

    document.getElementById('previewContent').innerHTML = content;
    document.getElementById('printPreviewModal').style.display = 'flex';
    document.getElementById('zoomRange').value = 0.5;
    applyZoom();
}

function toggleAll(master) {
    document.querySelectorAll('.print-row-check').forEach(chk => chk.checked = master.checked);
}

function applyZoom() {
    let z = document.getElementById('zoomRange').value;
    document.getElementById('zoomVal').innerText = Math.round(z*100) + "%";
    document.getElementById('previewContent').style.transform = `scale(${z})`;
    document.documentElement.style.setProperty('--p-zoom', z);
}

function closePreview() { document.getElementById('printPreviewModal').style.display='none'; }
  
/* ENTRY FUNCTIONS */  
function openEntryScreen(){
  const s = document.getElementById("season").value;
  if(!s){ alert("Season select karo"); return; }
  editID = null;
  customer.value = ""; father.value = ""; village.value = ""; bore.value = "";
  extra.value = ""; quintal.value = ""; note.value = "";
  document.getElementById("entrySeasonLabel").innerText = "Season: " + s;
  document.getElementById("entryScreen").style.display = "block";
  loadSuggestions();
  document.getElementById("entryDate").value = new Date().toISOString().split("T")[0];
  db.ref("seasonsInfo/" + s).once("value", snap => {
    defaultBW = Number(snap.val().defaultBw || 0);
    document.getElementById("defaultBW").value = defaultBW;
    autoCalc();
  });
}
function closeEntryScreen(){ document.getElementById("entryScreen").style.display = "none"; editID = null; }

function autoCalc(){
  const b = Number(bore.value || 0);
  const e = Number(extra.value || 0);
  const totalKg = (b * defaultBW) + e;
  quintal.value = (totalKg / 100).toFixed(3);
  calcAmount();
}

function calcAmount(){
  const rate = Number(document.getElementById("rate").value || 0);
  const b = Number(document.getElementById("bore").value || 0);
  const e = Number(document.getElementById("extra").value || 0);
  const totalKg = (b * defaultBW) + e;
  const qtl = totalKg / 100;
  let cut = 0;
  if(document.getElementById("cutBag").checked) cut += b * Number(document.getElementById("cutBagVal").value || 0);
  if(document.getElementById("cutQtl").checked) cut += qtl * Number(document.getElementById("cutQtlVal").value || 0);
  const net = (rate * qtl) - cut;
  document.getElementById("cutTotal").value = cut.toFixed(2);
  document.getElementById("amount").value   = net.toFixed(2);
}
  
function saveEntry(){  
 const data={
  customer:customer.value, father:father.value, village:village.value,
  bore:bore.value, extra:extra.value, quintal:quintal.value,
  rate: Number(document.getElementById("rate").value || 0),
  cut:  document.getElementById("cutTotal").value,
  amount: document.getElementById("amount").value,
  note:note.value, date:entryDate.value, timestamp:Date.now()
};
 if(!data.customer||!data.bore){ alert("Required"); return; }
 const ref=db.ref("seasons/"+season.value+"/entries");  
 editID?ref.child(editID).update(data):ref.push(data);  
 closeEntryScreen(); loadSeason();  
}

function loadSeason(){  
  const s = season.value; if(!s) return;  
  db.ref("seasonsInfo/" + s).once("value", snap => {  
    defaultBW = Number(snap.val()?.defaultBw || 0);  
    db.ref("seasons/" + s + "/entries").once("value", eSnap => {  
      const arr = Object.entries(eSnap.val() || {}).map(([id, v]) => ({ id, ...v })).sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));  
      updateTable(arr);  
    });  
  });  
}  

function updateTable(arr){  
  output.innerHTML = ""; let totalB = 0, totalKg = 0;  
  arr.forEach(r => {  
    totalB += Number(r.bore || 0);  
    const qKg = (Number(r.bore || 0) * defaultBW) + Number(r.extra || 0);  
    totalKg += qKg;  
    const qt = Math.floor(qKg / 100); const kg = qKg % 100;  
    output.innerHTML += `<tr>
  <td><input type="checkbox" class="print-row-check"></td>
  <td>${r.date || ""}</td>
  <td style="font-weight:bold; color:#0d6efd;">${r.customer || ""}</td>
  <td>${r.father || ""}</td><td>${r.village || ""}</td>  
  <td>${r.bore || ""}</td><td>${r.extra || 0}</td><td>${r.note || ""}</td><td>${qt} Qt ${kg} Kg</td>  
  <td>Gross ‚Çπ ${(Number(r.rate || 0) * (qKg / 100)).toFixed(2)}<br>Labour ‚Çπ ${r.cut || 0} <br><b>Net ‚Çπ ${r.amount || 0}</b></td>
  <td><button class="actionBtn" onclick="editEntry('${r.id}')">‚úè</button> <button class="actionBtn" onclick="deleteEntry('${r.id}')">üóë</button></td></tr>`;  
  });  
  totalBore.innerText = totalB; totalQtl.innerText = Math.floor(totalKg / 100) + " Qt " + (totalKg % 100) + " Kg";  
}  
  
function sortNewest(){ sortMode = "newest"; filterData(); }
function sortOldest(){ sortMode = "oldest"; filterData(); }
function sortNameAZ(){ sortMode = "az"; filterData(); }
function sortNameZA(){ sortMode = "za"; filterData(); }
  
function editEntry(id){  
  editID = id; document.getElementById("entryScreen").style.display = "block"; loadSuggestions();
  db.ref("seasons/"+season.value+"/entries/"+id).once("value", s => {  
    const d = s.val();  
    customer.value = d.customer; father.value = d.father; village.value = d.village;  
    bore.value = d.bore; extra.value = d.extra; quintal.value = d.quintal;  
    entryDate.value = d.date; note.value = d.note;
    document.getElementById("rate").value = d.rate || "";
    calcAmount();
  });  
}  
  
function loadSeasons(){  
 season.innerHTML="";  
 db.ref("seasonsInfo").once("value",s=>{  
  Object.keys(s.val()||{}).forEach(n=>{ season.innerHTML+=`<option>${n}</option>`; });  
  season.value=localStorage.lastSeason||season.options[0]?.value; loadSeason();  
 });  
}  
function onSeasonChange(){ localStorage.lastSeason=season.value;loadSeason(); }  

function newSeason(){
  document.getElementById("season").value = ""; document.getElementById("seasonName").value = "";
  document.getElementById("seasonWeight").value = ""; localStorage.removeItem("lastSeason");
  document.getElementById("seasonScreen").style.display = "block";
}

function openSeasonScreen(){  
  const s = document.getElementById("season").value; if(!s) return;
  document.getElementById("seasonScreen").style.display = "block";  
  db.ref("seasonsInfo/" + s).once("value", snap => {  
    const d = snap.val() || {};  
    document.getElementById("seasonName").value = d.name || s;  
    document.getElementById("seasonWeight").value = d.defaultBw || "";  
  });  
}  

function saveSeason(){  
  const oldName = document.getElementById("season").value;  
  const newName = document.getElementById("seasonName").value.trim();  
  const weight  = document.getElementById("seasonWeight").value;  
  if(!newName || !weight) return;
  db.ref("seasonsInfo/" + newName).set({ name:newName, defaultBw:weight });
  localStorage.lastSeason = newName; document.getElementById("seasonScreen").style.display = "none"; loadSeasons();
}  

function deleteSeason(){
  const s = document.getElementById("seasonName").value.trim(); if(!s) return;
  if(confirm("Season delete?")){
    db.ref("seasonsInfo/" + s).remove(); db.ref("seasons/" + s).remove();
    localStorage.removeItem("lastSeason"); document.getElementById("seasonScreen").style.display = "none";
    setTimeout(()=>{ loadSeasons(); },500);
  }
}

function filterData(){  
  const name = document.getElementById("searchName").value.toLowerCase();
  const from = document.getElementById("fromDate").value; const to = document.getElementById("toDate").value;
  const s = document.getElementById("season").value; if(!s) return;
  db.ref("seasons/" + s + "/entries").once("value", eSnap => {
    let arr = Object.entries(eSnap.val() || {}).map(([id,v]) => ({ id, ...v }));
    if(name) arr = arr.filter(r => (r.customer || "").toLowerCase().includes(name));
    if(from) arr = arr.filter(r => r.date >= from);
    if(to) arr = arr.filter(r => r.date <= to);
    if(sortMode === "oldest") arr.sort((a,b)=>a.timestamp-b.timestamp);
    else if(sortMode === "az") arr.sort((a,b)=>a.customer.localeCompare(b.customer));
    else if(sortMode === "za") arr.sort((a,b)=>b.customer.localeCompare(a.customer));
    else arr.sort((a,b)=>b.timestamp-a.timestamp);
    updateTable(arr);
  });
}

function loadSuggestions(){
  const s = document.getElementById("season").value; if(!s) return;
  db.ref("seasons/" + s + "/entries").once("value", snap => {
    const data = Object.values(snap.val() || {});
    const custs = [...new Set(data.map(d => d.customer).filter(Boolean))];
    const fats = [...new Set(data.map(d => d.father).filter(Boolean))];
    const vils = [...new Set(data.map(d => d.village).filter(Boolean))];
    document.getElementById("customerList").innerHTML = custs.map(n=>`<option value="${n}">`).join("");
    document.getElementById("fatherList").innerHTML = fats.map(n=>`<option value="${n}">`).join("");
    document.getElementById("villageList").innerHTML = vils.map(n=>`<option value="${n}">`).join("");
  });
}

loadSeasons();  
function deleteEntry(id){  
  const s = document.getElementById("season").value; if(!s) return;
  if(confirm("Delete?")){ db.ref("seasons/" + s + "/entries/" + id).remove().then(()=>{ loadSeason(); }); }
}  
function closeSeasonScreen(){ document.getElementById("seasonScreen").style.display = "none"; }
</script> 
</body>  
</html>
