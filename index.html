<!DOCTYPE html>  <html lang="hi">  
<head>  
<meta charset="UTF-8">  
<link rel="manifest" href="manifest.json">  
<title>Mandi App Final</title>  
<meta name="viewport" content="width=device-width, initial-scale=1">  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>  <style>  
body{font-family:Arial;padding:12px;background:#eef0f4;}  
button,input,select{  
 width:100%;padding:10px;margin:6px 0;border-radius:6px;  
 border:1px solid #aaa;font-size:15px;  
}  
button{background:#0d6efd;color:#fff;border:none;}  
.tableBox{background:#fff;border-radius:6px;overflow-y:auto;max-height:400px;}  
table{width:100%;border-collapse:collapse;}  
th,td{border:1px solid #ccc;padding:8px;font-size:14px;}  
th{background:#0d6efd;color:#fff;}  
.actionBtn{padding:4px 8px;background:#444;color:#fff;border:none;border-radius:4px;}  
.searchBar{background:#d9edff;padding:10px;border-radius:6px;margin-bottom:10px;}  
#entryScreen,#seasonScreen{  
 position:fixed;top:0;left:0;right:0;bottom:0;  
 background:#fff;padding:14px;display:none;z-index:999;overflow-y:auto;  
}  
  
@media print{  
 select,button,.searchBar,.actionBtn,#entryScreen,#seasonScreen,  
 thead th:last-child,tbody td:last-child{display:none!important;}  
 .tableBox{max-height:none!important;overflow:visible!important;}  
 body{background:white!important;}  
}  
</style>  </head>  <body>  <select id="season" onchange="onSeasonChange()"></select>
<button onclick="newSeason()">‚ûï New Season</button>

<div style="display:flex;gap:6px;">  
<button onclick="openSeasonScreen()">‚öô Season Setup</button>  
<button onclick="openEntryScreen()">‚ûï Add Entry</button>  
</div>  <div class="searchBar">  
<input id="searchName" placeholder="Search Customer" oninput="filterData()">  
<input type="date" id="fromDate" oninput="filterData()">  
<input type="date" id="toDate" oninput="filterData()">  
</div>  <div style="display:flex;gap:6px;">  
<button onclick="sortNewest()">Newest</button>  
<button onclick="sortOldest()">Oldest</button>  
<button onclick="sortNameAZ()">A ‚Üí Z</button>  
<button onclick="sortNameZA()">Z ‚Üí A</button>  
</div>  <div style="background:white;padding:10px;border-radius:6px;margin:10px 0;">  
<b>Total Bore:</b> <span id="totalBore">0</span> |  
<b>Total Quintal:</b> <span id="totalQtl">0</span>  
<button onclick="window.print()">üñ® Print</button>  
</div>  <div class="tableBox">  
<table>  
<thead>  
<tr>  
  <th>Date</th>  
  <th>Customer</th>  
<th>Father</th>
  <th>Village</th>  
  <th>Bore</th>  
  <th>Extra Kg</th>
<th>Note</th>
<th>Qtl</th>
<th>Actions</th>

</tr>  
</thead>  
<tbody id="output"></tbody>  
</table>  
</div>  <!-- ENTRY SCREEN -->  <div id="entryScreen">  
<h3>Add / Edit Entry</h3>  
<div id="entrySeasonLabel" style="font-weight:bold;color:#0d6efd"></div>  
<!-- Customer -->
<input id="customer" list="customerList" placeholder="Customer">
<datalist id="customerList"></datalist>

<!-- Father -->
<input id="father" list="fatherList" placeholder="Father (optional)">
<datalist id="fatherList"></datalist>

<!-- Village -->
<input id="village" list="villageList" placeholder="Village">
<datalist id="villageList"></datalist>
<input type="date" id="entryDate">  
<input id="defaultBW" readonly placeholder="Bore Weight">  
<input id="bore" type="number" placeholder="Bore"  
       oninput="autoCalc()" onblur="autoCalc()">  <input id="extra" type="number" placeholder="Extra Kg"  
oninput="autoCalc()" onblur="autoCalc()">
<input id="quintal" readonly placeholder="Quintal">
<input id="note" placeholder="Note (optional)">
<button onclick="saveEntry()">‚úî Save</button>
<button onclick="closeEntryScreen()">‚¨Ö Back</button>

</div>  <!-- SEASON -->  <div id="seasonScreen">  
<h3>Season Setup</h3>  
<input id="seasonName" placeholder="Season Name">  
<input id="seasonWeight" placeholder="Default Bore Weight">  
<button onclick="saveSeason()">‚úî Save</button>  
<button onclick="deleteSeason()">üóë Delete</button>  
<button onclick="closeSeasonScreen()">‚¨Ö Back</button>  
</div>  <script>  
/* FIREBASE */  
firebase.initializeApp({  
 apiKey:"AIzaSyAiwfHxzsreDK2RkYLXNjhb8DhMmpYZ-tY",  
 authDomain:"fasal-9a05b.firebaseapp.com",  
 databaseURL:"https://fasal-9a05b-default-rtdb.firebaseio.com",  
 projectId:"fasal-9a05b"  
});  
const db=firebase.database();  
let editID=null, defaultBW=0;  
let sortMode = "newest";
  
/* ENTRY */  function openEntryScreen(){

  const s = document.getElementById("season").value;
  if(!s){
    alert("Season select karo");
    return;
  }

  editID = null;

  customer.value = "";
  father.value = "";
  village.value = "";
  bore.value = "";
  extra.value = "";
  quintal.value = "";
  note.value = "";

  document.getElementById("entrySeasonLabel").innerText =
    "Season: " + s;

  document.getElementById("entryScreen").style.display = "block";

  loadSuggestions();   // ‚≠ê suggestions yahin load honge

  document.getElementById("entryDate").value =
    new Date().toISOString().split("T")[0];

  db.ref("seasonsInfo/" + s).once("value", snap => {
    defaultBW = Number(snap.val().defaultBw || 0);
    document.getElementById("defaultBW").value = defaultBW;
    autoCalc();
  });
}
 function closeEntryScreen(){
  document.getElementById("entryScreen").style.display = "none";
  editID = null;
}
function autoCalc(){  
 const bore=Number(bore.value||0);  
 const extra=Number(extra.value||0);  
 const totalKg=(bore*defaultBW)+extra;  
 quintal.value=(totalKg/100).toFixed(3);  
}  
  
/* SAVE ENTRY */  
function saveEntry(){  
 const data={
  customer:customer.value,
  father:father.value,
  village:village.value,
  bore:bore.value,
  extra:extra.value,
  note:note.value,   // ‚≠ê ADD THIS LINE
  quintal:quintal.value,
  date:entryDate.value,
  timestamp:Date.now()
};
 if(!data.customer||!data.bore){alert("Required");return;}  
 const ref=db.ref("seasons/"+season.value+"/entries");  
 editID?ref.child(editID).update(data):ref.push(data);  
 closeEntryScreen(); loadSeason();  
}  
  
/* LOAD */  
function loadSeason(){  
  
  const s = season.value;  
  if(!s) return;  
  
  // pehle season ka bore weight  
  db.ref("seasonsInfo/" + s).once("value", snap => {  
  
    defaultBW = Number(snap.val()?.defaultBw || 0);  
  
    // phir entries load  
    db.ref("seasons/" + s + "/entries").once("value", eSnap => {  
  
      const arr = Object.entries(eSnap.val() || {})  
        .map(([id, v]) => ({ id, ...v }))  
        .sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));  
  
      updateTable(arr);  
    });  
  });  
}  
  /* TOTAL + TABLE */  
function updateTable(arr){  
  
  output.innerHTML = "";  
  let totalB = 0, totalKg = 0;  
  
  arr.forEach(r => {  
    totalB += Number(r.bore || 0);  
  
    const bw = Number(defaultBW || 0);  
    const qKg = (Number(r.bore || 0) * bw) + Number(r.extra || 0);  
    totalKg += qKg;  
  
    const qt = Math.floor(qKg / 100);  
    const kg = qKg % 100;  
  
    output.innerHTML += `  
<tr>  
  <td>${r.date || ""}</td>  
  <td>${r.customer || ""}</td>  
<td>${r.father || ""}</td>
  <td>${r.village || ""}</td>  
  <td>${r.bore || ""}</td>  
  <td>${r.extra || 0}</td>
<td>${r.note || ""}</td>
<td>${qt} Qt ${kg} Kg</td>  
  <td>  
    <button class="actionBtn" onclick="editEntry('${r.id}')">‚úè</button>  
    <button class="actionBtn" onclick="deleteEntry('${r.id}')">üóë</button>  
  </td>  
</tr>`;  
  });  
  
  totalBore.innerText = totalB;  
  const tQt = Math.floor(totalKg / 100);  
  const tKg = totalKg % 100;  
  totalQtl.innerText = tQt + " Qt " + tKg + " Kg";  
}  
  
/* SORT */  
function sortNewest(){
  sortMode = "newest";
  filterData();
}

function sortOldest(){
  sortMode = "oldest";
  filterData();
}

function sortNameAZ(){
  sortMode = "az";
  filterData();
}

function sortNameZA(){
  sortMode = "za";
  filterData();
}  
  
/* EDIT DELETE */  
function editEntry(id){  
  
  // ‚úÖ EDIT MODE SABSE PEHLE  
  editID = id;  
  
  // open screen (direct)  
  document.getElementById("entryScreen").style.display = "block";  
loadSuggestions();
  
  // season label  
  document.getElementById("entrySeasonLabel").innerText =  
    "Season: " + season.value;  
  
  // load old data  
  db.ref("seasons/"+season.value+"/entries/"+id).once("value", s => {  
    const d = s.val();  
  
    customer.value  = d.customer || "";  
    father.value    = d.father   || "";  
    village.value   = d.village  || "";  
    bore.value      = d.bore     || "";  
    extra.value     = d.extra    || "";  
    quintal.value   = d.quintal  || "";  
    entryDate.value = d.date     || "";  
note.value = d.note || "";
  
    // ‚úÖ SEASON SE BORE WEIGHT FIR SE LOAD  
db.ref("seasonsInfo/" + season.value).once("value", snap => {  
  defaultBW = Number(snap.val().defaultBw || 0);  
  document.getElementById("defaultBW").value = defaultBW;  
  autoCalc();  
});  
  });  
}  
  
/* SEASON */  
function loadSeasons(){  
 season.innerHTML="";  
 db.ref("seasonsInfo").once("value",s=>{  
  Object.keys(s.val()||{}).forEach(n=>{  
   season.innerHTML+=`<option>${n}</option>`;  
  });  
  season.value=localStorage.lastSeason||season.options[0]?.value;  
  loadSeason();  
 });  
}  
function onSeasonChange(){  
 localStorage.lastSeason=season.value;loadSeason();  
}  
function newSeason(){

  // dropdown clear
  document.getElementById("season").value = "";

  // input fields clear
  document.getElementById("seasonName").value = "";
  document.getElementById("seasonWeight").value = "";

  // last selected season remove
  localStorage.removeItem("lastSeason");

  // open setup screen
  document.getElementById("seasonScreen").style.display = "block";
}
function openSeasonScreen(){  
  
  const s = document.getElementById("season").value;  
  
  if(!s){  
    alert("Pehle season select karo");  
    return;  
  }  
  
  // screen open  
  document.getElementById("seasonScreen").style.display = "block";  
  
  // selected season ka data load  
  db.ref("seasonsInfo/" + s).once("value", snap => {  
    const d = snap.val() || {};  
  
    // üî• YAHI MAIN FIX HAI  
    document.getElementById("seasonName").value   = d.name || s;  
    document.getElementById("seasonWeight").value = d.defaultBw || "";  
  });  
}  
function saveSeason(){  
  
  const oldName = document.getElementById("season").value;  
  const newName = document.getElementById("seasonName").value.trim();  
  const weight  = document.getElementById("seasonWeight").value;  
  
  if(!newName || !weight){  
    alert("Name aur weight required hai");  
    return;  
  }  
  
  // üîµ RENAME CASE  
  if(oldName && oldName !== newName){  
  
    db.ref("seasons/" + oldName).once("value").then(snap => {  
  
      const data = snap.val() || { entries:{} };  
  
      // new season create  
      db.ref("seasons/" + newName).set(data);  
      db.ref("seasonsInfo/" + newName).set({  
        name:newName,  
        defaultBw:weight  
      });  
  
      // old season delete  
      db.ref("seasons/" + oldName).remove();  
      db.ref("seasonsInfo/" + oldName).remove();  
  
      localStorage.lastSeason = newName;  
      document.getElementById("seasonScreen").style.display = "none";  
      loadSeasons();  
    });  
  
  }   
  // üü¢ NORMAL SAVE  
  else {  
  
    db.ref("seasonsInfo/" + newName).set({  
      name:newName,  
      defaultBw:weight  
    });  
  
    localStorage.lastSeason = newName;  
    document.getElementById("seasonScreen").style.display = "none";  
    loadSeasons();  
  }  
}  
function deleteSeason(){

  // season name input se lo (dropdown se nahi)
  const s = document.getElementById("seasonName").value.trim();

  if(!s){
    alert("Season name nahi hai");
    return;
  }

  if(confirm("Season permanently delete kare?")){

    db.ref("seasonsInfo/" + s).remove();
    db.ref("seasons/" + s).remove();

    localStorage.removeItem("lastSeason");

    document.getElementById("seasonScreen").style.display = "none";

    setTimeout(()=>{
      loadSeasons();
    },500);
  }
}
function filterData(){  
  
  const name = document.getElementById("searchName").value.toLowerCase();  
  const from = document.getElementById("fromDate").value;  
  const to   = document.getElementById("toDate").value;  
  
  const s = document.getElementById("season").value;  
  if(!s) return;  
  
  // pehle bore weight  
  db.ref("seasonsInfo/" + s).once("value", snap => {  
  
    defaultBW = Number(snap.val()?.defaultBw || 0);  
  
    db.ref("seasons/" + s + "/entries").once("value", eSnap => {  
  
      let arr = Object.entries(eSnap.val() || {})  
        .map(([id,v]) => ({ id, ...v }));  
  
      // üîç NAME FILTER  
      if(name){  
        arr = arr.filter(r =>  
          (r.customer || "").toLowerCase().includes(name)  
        );  
      }  
  
      // üìÖ DATE FILTER  
      if(from){  
        arr = arr.filter(r => r.date >= from);  
      }  
      if(to){  
        arr = arr.filter(r => r.date <= to);  
      }  
  
      // newest first  
      if(sortMode === "oldest"){
  arr.sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));
}
else if(sortMode === "az"){
  arr.sort((a,b)=>(a.customer||"").localeCompare(b.customer||""));
}
else if(sortMode === "za"){
  arr.sort((a,b)=>(b.customer||"").localeCompare(a.customer||""));
}
else{
  arr.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
}
  
      updateTable(arr);  
    });  
  });  
}  
function loadSuggestions(){

  const s = document.getElementById("season").value;
  if(!s) return;

  db.ref("seasons/" + s + "/entries").once("value", snap => {

    const data = Object.values(snap.val() || {});

    const customers = [...new Set(data.map(d => d.customer).filter(Boolean))];
    const fathers   = [...new Set(data.map(d => d.father).filter(Boolean))];
    const villages  = [...new Set(data.map(d => d.village).filter(Boolean))];

    const customerList = document.getElementById("customerList");
    const fatherList   = document.getElementById("fatherList");
    const villageList  = document.getElementById("villageList");

    customerList.innerHTML = "";
    fatherList.innerHTML = "";
    villageList.innerHTML = "";

    customers.forEach(name=>{
      customerList.innerHTML += `<option value="${name}">`;
    });

    fathers.forEach(name=>{
      fatherList.innerHTML += `<option value="${name}">`;
    });

    villages.forEach(name=>{
      villageList.innerHTML += `<option value="${name}">`;
    });

  });
}
loadSeasons();  
function deleteEntry(id){  
  
  const s = document.getElementById("season").value;  
  if(!s){  
    alert("Season select nahi hai");  
    return;  
  }  
  
  if(confirm("Delete?")){  
    db.ref("seasons/" + s + "/entries/" + id)  
      .remove()  
      .then(()=>{  
        loadSeason();   // table refresh  
      })  
      .catch(err=>{  
        alert("Delete failed");  
        console.error(err);  
      });  
  }  
}  
function closeSeasonScreen(){
  document.getElementById("seasonScreen").style.display = "none";
}
</script> 
 </body>  
</html>